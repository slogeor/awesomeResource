## 前端自动化测试简介

### 为什么需要自动化测试

一个项目最终会经过快速迭代走向以维护为主的状态，在合理的时机以合理的方式引入自动化测试能有效减少人工维护成本。自动化测试的收益可以简单总结为：

```
自动化的收益 = 迭代次数 * 全手动执行成本 - 首次自动化成本 - 维护次数 * 维护成本
```

对于自动化测试来说，相对于发现未知的问题，``` 更倾向于避免可能的问题。```

### 前端自动化测试的几个方向

* 界面回归测试: 测试界面是否正常，这是前端测试最基础的环节
* 功能测试: 测试功能操作是否正常，由于涉及交互，这部分测试比界面测试会更复杂
* 性能测试: 页面性能越来越受到关注，并且性能需要在开发过程中持续关注，否则很容易随着业务迭代而下降。
* 页面特征检测: 有些动态区域无法通过界面对比进行测试、也没有功能上的异常，但可能不符合需求。例如性能测试中移动端大图素材检测就是一种特征检测，另外常见的还有页面区块静态资源是否符合预期等等。

#### 1. 界面回归测试

界面回归测试常见的做法有像素对比和dom结构对比两个方向。

**像素对比**

像素对比基本的思想认为，如果网站没有因为你的改动而界面错乱，那么在截图上测试页面应当跟正常页面保持一致。可以跟线上正常页面对比或者页面历史记录对比。像素对比能直观的显示图像上的差异，如果达到一定阈值则页面可能不正常

测试工具

* 测试多浏览器: selenium 可以自动化的获取多个浏览器下的截图，前端工程师来说还可以借助Node的 webdriver 来轻松开发测试脚本。多浏览器可能更适用回归性测试
* 像素对比比较出名的工具是PhantomCSS。 PhantomCSS结合了 Casperjs截图和ResembleJs 图像对比分析
* 响应式页面测试: 通过PhantomJS、capserJS等工具在不同尺寸下截图然后根据resemberJS进行像素比对判断是否正常

像素对比需要注意的问题

* 不建议对网站所有页面进行测试 这只会导致很容易出现告警，但不一定是错误。针对重复使用的组件和样式、容易出问题的区域测试更加有效
* 推荐测试区域而不是整个页面 整个页面的测试导致任何一点文字、图像等动态的改变都可能导致不通过，而且真正的错误可能由于图像太大而被阈值忽略。图像越大对比也越容易超时。
* 隐藏动态区域 在选择器对应的区域如果有动态元素，可以同样通过选择器来隐藏
* 界面对比只是一个环节，需与其他测试相结合 没有银弹，合理结合才是关键

**dom结构对比**
像素对比虽然直观，但动态元素居多且无法保证测试页面与线上页面同步时有所局限。解决方案page-monitor，根据dom结构与样式的对比来对比整个页面的变动部分。

#### 2. 功能测试

* Phantom JS是一个服务器端的 JavaScript API 的 WebKit。其支持各种Web标准： DOM 处理, CSS 选择器, JSON, Canvas, 和 SVG。对于web测试、界面、网络捕获、页面自动化访问等等方面可以说是信手拈来。

* casperjs是对PhantomJS的封装，提供了更加易用的API, 增强了测试等方面的支持。

* PhantomFlow假定如果页面正常，那么在相同的操作下，测试页面与正常页面的展现应该是一样的。 基于这点，用户只需要定义一系列操作流程和决策分支，然后利用PhantomCSS进行截图和图像对比。最后在一个很赞的可视化报表中展现出来

### 单元测试

* 需要访问数据库的测试不是单元测试
* 需要访问网络的测试不是单元测试
* 需要访问文件系统的测试不是单元测试

单元测试中应该避免什么？

* 太多的条件逻辑
* 构造函数中做了太多事情
* too many全局变量
* too many静态方法
* 无关逻辑
* 过多外部依赖

### 测试驱动开发（TDD）

* 单元测试的首要目的不是为了能够编写出大覆盖率的全部通过的测试代码，而是需要从使用者(调用者)的角度出发，尝试函数逻辑的各种可能性，进而辅助性增强代码质量
* 测试是手段而不是目的。测试的主要目的不是证明代码正确，而是帮助发现错误，包括低级的错误
* 测试要快。快速运行、快速编写
* 测试代码保持简洁
* 不会忽略失败的测试。

### 测试工具

* Mocha + Chai
* PhantomJS or CasperJS or Nightwatch.js
* selenium
	* with python
	* with js

#### 1. mocha + chai的API/Func UnitTest

mocha是一套前端测试工具，我们可以拿它和其他测试工具搭配。

而chai则是BDD/TDD测试断言库，提供诸如expect这样的测试语法

#### 2. 基于phantomjs和selenium的UI UnitTest

PhantomJS是一个基于webkit的服务器端JavaScript API，即相当于在内存中跑了个无界面的webkit内核的浏览器。通过它我们可以模拟页面加载，并获取到页面上的DOM元素，进行一系列的操作，以此来模拟UI测试。但缺点是无法实时看见页面上的情况（不过可以截图）。

而Selenium是专门为Web应用程序编写的一个验收测试工具，它直接运行在浏览器中。Selenium测试通常会调起一个可见的界面，但也可以通过设置，让它以PhantomJS的形式进行无界面的测试。

* open 某个 url
* 监听 onload 事件
* 事件完成后调用 sendEvent 之类的 api 去点击某个 DOM 元素所在 * point
* 触发交互
* 根据 UI 交互情况 延时 setTimeout （规避惰加载组件点不到的情况）继续 sendEvent 之类的交互

### 参考链接

* [前端自动化测试探索](http://fex.baidu.com/blog/2015/07/front-end-test/)
* [selenium](http://www.seleniumhq.org/)
* [webdriver](http://webdriver.io/)
* [前端自动化测试探索](http://fex.baidu.com/blog/2015/07/front-end-test/)