#### 目标

首屏优化

#### 现状

对于通用的移动 Web 性能优化，首先要考虑的是网络传输性能。

浏览器获取一个资源，花在网络上的时间开销至少有这几块：DNS 解析、建立 TCP 连接、发送请求、等待响应、传输响应正文。相比 PC 的网络环境，移动端更为糟糕，集中在这几点：高时延、高丢包、低速率、多劫持。

所以，在移动 WEB 上，引入外链资源的网络成本非常高。

头部的外链 CSS、JS 会阻塞页面渲染，通俗来讲就是头部的这些外链资源加载完之前，页面会一直白屏。之前我们统计过，一个 GZip 后十几 KB 的头部 JS，会增加大概半秒的白屏时间。

#### 观点

重要的 CSS、JS 直接内联在 HTML 中，头部禁止出现任何外链资源。

对于头部内联 JS，我只有两点要求：1）没有耗时操作；2）只保留必要代码。

#### 存在的问题

多次请求之间无法利用缓存，浪费流量，也让移动网络低速率的问题雪上加霜。

#### 解决方案

引入了 localStorage 方案：用户首次访问时，服务端输出包含内联 CSS、JS 和 JSON 数据的页面，并通过 JS 将这些数据存入 localStorage；用户后续访问时，服务端只需要输出从 localStorage 读取并执行代码的 JS 片段即可。

#### 方案难点

1. 服务端如何得知用户本地存有 localStorage
2. 服务端如何得知用户本地存的 localStorage 中的某个具体文件的版本是否最新

#### 完美方案

首先，我们引入了由以下字符组成的 70 进制：

<code>
0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz~!()*_-.
</code>

然后，在编译流程中，对全站代码里所有需要存入 localStorage 的资源（我们通过外链标签是否存在某个自定义属性来判断）进行分析，生成文件名及对应版本号的 Map 文件。

```js
{
    'file/path/to/js/1.js' : { filename : '0', version : '0', md5 : '‍xxx'},
    'file/path/to/js/2.js' : { filename : '1', version : '0', md5 : 'yyy'},
    'file/path/to/css/1.css' : { filename : '2', version : '0', md5 : 'zzz'},
}
```
每次编译都需要重新构建，但有两点需要保证。

1. 相同文件路径对应的 70 进制字符标记必须固定
2. 文件内容 md5 发生变化时，对应的版本号需要 +1


#### 特别关注点

1. 首先，移动端部分浏览器在隐私模式下，访问 localStorage 对象会直接抛出异常，必须把 localStorage 的几个方法包装一下，加上 try。
2. 如果 Cookie 中的标记存在，但是 localStorage 内容丢失如何处理？

#### 结论

资源内联可以缓解移动端网络的高时延、高丢包等问题；而资源 localStorage 化可以应对低速率；二者结合使用，才能有最好的效果

重要的 CSS、JS、JSON 数据直接内联在 HTML 中，头部禁止出现任何外链资源。同时，尽可能减少页面传输体积。

#### 其它场景

服务端始终输出一个处理后续js、css文件引入方式的内联script，当发现localStorage中不存在相应的静态资源或版本需要更新时，该script负责动态引入所需的资源。

原文

[移动 WEB 通用优化策略介绍（一）](https://imququ.com/post/wpo-of-mobile-web-1.html)